<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Chatbot Má»¹ TiÃªn â€” Phá»ng váº¥n (Giá»ng Ban Mai)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{--primary:#f06b9a;--muted:#666;}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
  body{background:linear-gradient(180deg,#f4f6f8 0%,#eef2f6 100%);
        display:flex;align-items:center;justify-content:center;padding:28px}
  .card{width:460px;max-width:96%;background:#fff;border-radius:14px;
        box-shadow:0 12px 40px rgba(14,18,30,0.08);padding:18px;text-align:center}
  h1{margin:6px 0;color:var(--primary);font-size:20px}
  p.lead{margin:6px 0 12px;color:var(--muted);font-size:14px}
  .avatar-frame{width:300px;height:300px;border-radius:18px;overflow:hidden;
                margin:12px auto;position:relative;background-size:cover;
                background-position:center;transition:transform 0.25s ease}
  .avatar-frame.with-img{background-image:url('office_bg.jpg')}
  .avatar-frame::after{content:'';position:absolute;inset:0;
      background:linear-gradient(to top,rgba(0,0,0,0.12),rgba(255,255,255,0.02));
      pointer-events:none}
  .avatar-wrapper{position:relative;width:100%;height:100%;display:flex;
      align-items:center;justify-content:center;z-index:2}
  .avatar{width:92%;height:92%;object-fit:cover;border-radius:10px;
      transition:transform 0.12s ease,filter 0.12s ease}
  .eyes::before,.eyes::after{content:"";position:absolute;top:44%;width:22%;height:6%;
      background:rgba(0,0,0,0.6);border-radius:50%;opacity:0;
      transition:opacity 0.12s ease;pointer-events:none}
  .eyes::before{left:30%}.eyes::after{right:30%}
  .avatar-wrapper.blink .eyes::before,.avatar-wrapper.blink .eyes::after{opacity:1}
  .avatar-wrapper.smile .avatar{transform:scale(1.02) translateY(-3px);
      filter:brightness(1.05)}
  .nameplate{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);
      background:rgba(0,0,0,0.65);color:#fff;padding:6px 12px;border-radius:999px;
      font-weight:600;font-size:15px;z-index:3;
      box-shadow:0 6px 18px rgba(0,0,0,0.18)}
  .controls{display:flex;gap:8px;justify-content:center;margin-top:10px}
  button{background:var(--primary);color:#fff;border:0;border-radius:8px;
      padding:10px 14px;cursor:pointer}
  button[disabled]{opacity:0.6;cursor:not-allowed}
  .secondary{background:#7a8a98;padding:10px 12px}
  .status{margin-top:10px;color:var(--muted);font-size:13px}
  @media (max-width:520px){.avatar-frame{width:240px;height:240px}}
</style>
</head>
<body>
  <div class="card">
    <h1>Chatbot HR â€” Má»¹ TiÃªn ğŸ’¼</h1>
    <p class="lead">Phá»ng váº¥n nhÃ¢n sá»± â€” báº±ng tiáº¿ng Viá»‡t (Giá»ng Ban Mai)</p>

    <div id="avatarFrame" class="avatar-frame with-img parallax">
      <div class="avatar-wrapper" id="avatarWrap">
        <img id="avatar" class="avatar" src="avatar_hr.png" alt="Má»¹ TiÃªn" />
        <div class="eyes"></div>
        <div class="nameplate">Má»¹ TiÃªn â€” NhÃ¢n sá»±</div>
      </div>
    </div>

    <div class="controls">
      <button id="startBtn">ğŸ™ï¸ Báº¯t Ä‘áº§u phá»ng váº¥n</button>
      <button id="stopBtn" disabled class="secondary">â¹ Dá»«ng</button>
    </div>

    <div class="status" id="statusText">Nháº¥n "Báº¯t Ä‘áº§u phá»ng váº¥n" Ä‘á»ƒ khá»Ÿi Ä‘á»™ng.</div>
  </div>

<script>
const QUESTIONS = [
  "ChÃ o báº¡n, hÃ´m nay báº¡n tháº¿ nÃ o?",
  "TÃ´i tháº¥y báº¡n thÆ°á»ng Ä‘áº¿n há»p hÆ¡i trá»… vÃ i phÃºt. Báº¡n nghÄ© sao vá» Ä‘iá»u nÃ y?",
  "TÃ´i Ä‘Ã£ giÃºp báº¡n hoÃ n thÃ nh pháº§n bÃ i cá»§a báº¡n rá»“i Ä‘Ã³.",
  "Cáº£m Æ¡n báº¡n vÃ¬ cuá»™c trao Ä‘á»•i hÃ´m nay."
];

let current = 0, recognition = null, isRunning = false, waitingGoodbye = false, firstGreetingDone = false;
const statusEl = document.getElementById('statusText');
const avatarWrap = document.getElementById('avatarWrap');
const avatarFrame = document.getElementById('avatarFrame');
function setStatus(t){ statusEl.textContent=t; }

/* ==== SPEAK ==== */
function playAudioBlob(blob){
  return new Promise((resolve,reject)=>{
    const url=URL.createObjectURL(blob);
    const audio=new Audio(url);
    audio.volume=1.0;
    const p=audio.play();
    if(p)p.catch(()=>alert("TrÃ¬nh duyá»‡t cháº·n phÃ¡t tá»± Ä‘á»™ng, hÃ£y click láº¡i."));
    audio.onended=()=>{URL.revokeObjectURL(url);resolve();};
    audio.onerror=e=>{URL.revokeObjectURL(url);reject(e);};
  });
}
async function speakServer(msg){
  try{
    const r=await fetch('/api/tts',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({text:msg})
    });
    if(r.status===200){
      const b=await r.blob();
      await playAudioBlob(b);
      return;
    }
  }catch(e){console.error("TTS error",e);}
}

/* ==== Gá»ŒI GPT (Ä‘Æ¡n giáº£n, khÃ´ng stream) ==== */
async function streamGPTReply(userInput){
  try{
    const r=await fetch('/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:userInput,contextIndex:current})
    });
    const j=await r.json();
    const reply=j.reply?.trim()||"";
    if(reply){
      let cleanText=reply.replace(/\s+/g," ").replace(/[0-9]+/g,"").trim();
      await speakServer(cleanText);
      return cleanText;
    }
  }catch(e){console.error("Chat fetch error",e);}
  return "";
}

/* ==== ANIM ==== */
function startAutoBlink(){
  setInterval(()=>{
    avatarWrap.classList.add('blink');
    setTimeout(()=>avatarWrap.classList.remove('blink'),160);
  },3800+Math.random()*1200);
}
async function playSpeakingAnimation(){
  avatarWrap.classList.add('smile');
  avatarFrame.style.transform='translateY(-4px) scale(1.01)';
  setTimeout(()=>{
    avatarWrap.classList.remove('smile');
    avatarFrame.style.transform='';
  },1300);
}

/* ==== SPEECH ==== */
function initRecognition(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ voice. DÃ¹ng Chrome.");return null;}
  const r=new SR();
  r.lang='vi-VN';
  r.interimResults=false;
  r.maxAlternatives=1;
  r.onstart=()=>setStatus("ğŸ¤ Äang nghe...");
  r.onerror=e=>setStatus("KhÃ´ng nghe rÃµ, nÃ³i láº¡i nhÃ©!");
  r.onend=()=>setStatus("â³ Äang xá»­ lÃ½...");

  r.onresult=async e=>{
    const userText=e.results[0][0].transcript;
    console.log("ğŸ™ï¸ Báº¡n nÃ³i:", userText); // âœ… LOG 1: hiá»ƒn thá»‹ giá»ng nÃ³i nháº­n Ä‘Æ°á»£c
    setStatus("ğŸ§  Äang pháº£n há»“i...");
    await playSpeakingAnimation();

    if(!firstGreetingDone){
      const reply=await streamGPTReply(userText);
      console.log("ğŸ¤– GPT tráº£ lá»i:", reply); // âœ… LOG 2: hiá»ƒn thá»‹ pháº£n há»“i GPT
      firstGreetingDone=true;
      await speakServer(QUESTIONS[current]);
      r.start();
      return;
    }

    if(waitingGoodbye){
      await speakServer("Ráº¥t vui Ä‘Æ°á»£c trÃ² chuyá»‡n cÃ¹ng báº¡n. Háº¹n gáº·p láº¡i!");
      setStatus("âœ… Káº¿t thÃºc phá»ng váº¥n.");
      isRunning=false; waitingGoodbye=false;
      return;
    }

    const reply=await streamGPTReply(userText);
    console.log("ğŸ¤– GPT tráº£ lá»i:", reply); // âœ… LOG 2: pháº£n há»“i á»Ÿ cÃ¡c cÃ¢u tiáº¿p theo
    current++;
    if(current<QUESTIONS.length){
      await speakServer(QUESTIONS[current]);
      r.start();
    }else{
      waitingGoodbye=true;
      await speakServer("Cáº£m Æ¡n báº¡n vÃ¬ cuá»™c trao Ä‘á»•i hÃ´m nay.");
      r.start();
    }
  };
  return r;
}

/* ==== START ==== */
document.getElementById('startBtn').onclick=async()=>{
  if(isRunning)return;
  isRunning=true;current=0;waitingGoodbye=false;firstGreetingDone=false;
  recognition=initRecognition();
  await playSpeakingAnimation();
  await speakServer("Xin chÃ o, tÃ´i lÃ  Má»¹ TiÃªn, phá»¥ trÃ¡ch nhÃ¢n sá»±. Ráº¥t vui Ä‘Æ°á»£c gáº·p báº¡n hÃ´m nay!");
  recognition.start();
};
document.getElementById('stopBtn').onclick=()=>{
  if(recognition)recognition.stop();
  isRunning=false;
  setStatus("ÄÃ£ dá»«ng.");
};
startAutoBlink();
</script>
</body>
</html>
